<!DOCTYPE html>
<html lang="en">
	<head>
		<%- include('../partials/head'); %>
		<style>
			.draggable {
				cursor: move;
			}

			.draggable.dragging {
				opacity: 0.5;
			}
			.preview-image {
				height: auto;
				width: 5vw;
			}
			.preview-folder {
				font-size: 4vw;
			}
			#tabelPlace tr {
				cursor: pointer;
			}
		</style>
	</head>
	<header><%- include('../partials/header'); %></header>
	<body>
		<main class="container">
			<div class="alert" id="genInfoAlert"></div>
			<div class="container">
				<a
					class="btn btn-outline-success"
					data-bs-toggle="offcanvas"
					href="#offCanvasCreateFolder"
					role="button"
					aria-controls="offCanvasCreateFolder"
				>
					<i class="fas fa-folder-plus" style="font-size: 4vh"></i> Add Folder
				</a>
			</div>
			<div class="row">
				<div class="col">
					<table class="table">
						<thead>
							<tr>
								<th scope="col">Preview</th>
								<th scope="col">Name</th>
								<th scope="col">Actions</th>
							</tr>
						</thead>
						<tbody id="tabelPlace"></tbody>
					</table>
				</div>
				<div class="col-3"></div>
			</div>
		</main>
		<footer><%- include('../partials/footer'); %></footer>
	</body>
	<%- include('../partials/scripts'); %>
	<script src="dragDrop.js"></script>
	<script>
		let ROOTUUID;
		let viewDIR;

		function changeDir(UUID) {
			window.location = window.location.origin + '/myspace/' + UUID;
		}

		async function loadEntrys() {
			const response = await get('entry/' + viewDIR);
			if (!response.success) {
				alert('#genInfoAlert', response.success, response.json.error.message);
				return;
			}
			response.json.forEach((entry) => {
				appendEntry(entry);
			});
		}

		function appendEntry(entry) {
			const tr = document.createElement('tr');
			tr.classList.add('draggable');
			tr.setAttribute('draggable', true);
			tr.setAttribute('data-entry-UUID', entry.UUID);
			tr.innerHTML = `<td><img src="http://localhost:3100/image/${
				entry.UUID
			}?key=SECRET-DEV-KEY" class="img-thumbnail preview-image" /></td>
						<td>${entry.UUID.split('-')[0]}</td>
						<td><button onclick="deleteEntry('${
							entry.UUID
						}')" href="" class="btn btn-outline-danger"><i class="far fa-trash-alt" style="font-size: 4vh"></i></button></td>`;

			tabelPlace.appendChild(tr);
		}

		async function getRootFolder() {
			if (ROOTUUID) return ROOTUUID;
			const response = await get('folder');
			if (!response.success) {
				alert('#genInfoAlert', response.success, response.json.error.message);
				return;
			}
			response.json.forEach((dir) => {
				if (dir.name == 'ROOT') ROOTUUID = dir.UUID;
			});
			return ROOTUUID;
		}

		async function loadFolders() {
			await getRootFolder();
			if (true) viewDIR = ROOTUUID; // Here comes the ejs url folder thingi
			const response = await get('folder/' + viewDIR);
			if (!response.success) {
				alert('#genInfoAlert', response.success, response.json.error.message);
				return;
			}
			response.json.forEach((dir) => {
				appendFolder(dir);
			});
		}

		function appendFolder(dir) {
			const tr = document.createElement('tr');
			tr.classList.add('draggable');
			tr.classList.add('place');
			tr.setAttribute('draggable', true);
			tr.setAttribute('data-folder-UUID', dir.UUID);
			tr.innerHTML = `<tr class="draggable place" draggable="true">
						<td onclick="changeDir('${dir.UUID}')"><i class="far fa-folder preview-folder"></i></td>
						<td onclick="changeDir('${dir.UUID}')">${dir.name}</td>
						<td>${
							dir.name == '...'
								? ''
								: '<button onclick="deleteFolder()" href="" class="btn btn-outline-danger"><i class="far fa-trash-alt" style="font-size: 4vh"></i></button>'
						}</td>
					</tr>`;
			tabelPlace.appendChild(tr);
		}

		(async () => {
			await loadFolders();
			await loadEntrys();

			initDragDrop();
		})();
	</script>
</html>
