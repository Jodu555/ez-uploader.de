<nav
	class="navbar navbar-expand-lg navbar-light bg-light"
	style="background-color: #dbf9ff !important"
>
	<div class="container-fluid">
		<a class="navbar-brand" href="#"
			><img src="https://images.jodu555.de/ez-uploader.png" alt=""
		/></a>
		<button
			class="navbar-toggler"
			type="button"
			data-bs-toggle="collapse"
			data-bs-target="#navbarSupportedContent"
			aria-controls="navbarSupportedContent"
			aria-expanded="false"
			aria-label="Toggle navigation"
		>
			<span class="navbar-toggler-icon"></span>
		</button>
		<div class="collapse navbar-collapse" id="navbarSupportedContent">
			<ul
				class="navbar-nav mb-2 mb-lg-0"
				id="navFiller"
				style="margin-right: calc(50vw / 4.9)"
			></ul>
			<form class="d-flex me-auto">
				<input
					id="nameSearch"
					class="form-control me-1"
					type="search"
					placeholder="Search"
					aria-label="Search"
				/>
				<button class="btn btn-outline-success" type="submit">
					<i class="fas fa-search"></i>
				</button>
			</form>
		</div>
	</div>
</nav>

<div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasProfile">
	<div class="offcanvas-header">
		<h5>Profile Information</h5>
		<button
			type="button"
			class="btn-close text-reset"
			data-bs-dismiss="offcanvas"
			aria-label="Close"
		></button>
	</div>
	<div class="offcanvas-body">...</div>
</div>

<div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasLogin" data-bs-backdrop="false">
	<div class="offcanvas-header">
		<h5>Login / Register</h5>
		<button
			type="button"
			class="btn-close text-reset"
			data-bs-dismiss="offcanvas"
			aria-label="Close"
		></button>
	</div>
	<div class="offcanvas-body">
		<ul class="nav nav-tabs text-center justify-content-center" id="myTab" role="tablist">
			<li class="nav-item" role="presentation">
				<button
					class="nav-link active"
					data-bs-toggle="tab"
					data-bs-target="#login"
					type="button"
					role="tab"
					aria-controls="login"
					aria-selected="true"
				>
					Login
				</button>
			</li>
			<li class="nav-item" role="presentation">
				<button
					class="nav-link"
					data-bs-toggle="tab"
					data-bs-target="#register"
					type="button"
					role="tab"
					aria-controls="register"
					aria-selected="false"
				>
					Register
				</button>
			</li>
		</ul>
		<div class="tab-content" id="myTabContent">
			<div class="tab-pane fade show active" id="login" role="tabpanel" aria-labelledby="login-tab">
				<form class="mt-3" id="loginForm">
					<div class="mb-3">
						<label for="email" class="form-label">Email address</label>
						<input
							required
							type="email"
							name="email"
							class="form-control"
							autocomplete="email"
							id="email"
						/>
					</div>
					<div class="mb-3">
						<label for="password" class="form-label">Password</label>
						<input
							required
							type="password"
							name="password"
							autocomplete="current-password"
							class="form-control"
							id="password"
						/>
					</div>
					<button type="submit" class="btn btn-primary">Login</button>
				</form>
			</div>
			<div class="tab-pane fade" id="register" role="tabpanel" aria-labelledby="register-tab">
				<div id="registerAlert" style="display: none" class="alert"></div>
				<form class="mt-3" id="registerForm">
					<div class="mb-3">
						<label for="registerEmail" class="form-label">Email address</label>
						<input required type="email" name="email" class="form-control" />
					</div>
					<div class="mb-3">
						<label for="registerUsername" class="form-label">Username</label>
						<input required type="text" name="username" autocomplete="off" class="form-control" />
					</div>
					<div class="mb-3">
						<label for="registerPassword" class="form-label">Password</label>
						<input
							required
							type="password"
							name="password"
							autocomplete="off"
							class="form-control"
						/>
					</div>
					<button type="submit" class="btn btn-primary">Register</button>
				</form>
			</div>
		</div>
	</div>
</div>

<script src="http://docs.jodu555.de/utils/utils.js"></script>
<script src="utils.js"></script>

<script>
	const navigation = [
		{ page: ['index', '/'], display: 'Home' },
		{ page: 'discover', display: 'Discover' },
		{ page: 'uploader', display: 'Upload' },
		{ page: 'myspace', display: 'MySpace' },
	];
	const loginForm = document.querySelector('#loginForm');
	const registerForm = document.querySelector('#registerForm');

	const currentPage = getCurrentPage();

	registerForm.addEventListener('submit', async (e) => {
		e.preventDefault();
		const obj = formDataToObject(new FormData(registerForm));
		const response = await post('auth/register', JSON.stringify(obj), true);
		console.log(response);
		alert(
			'#registerAlert',
			response.success,
			response.json.error ? response.json.error.message : 'Successfully registered!'
		);
		if (response.success) registerForm.reset();
	});

	generateNavBar('#navFiller', navigation);

	renderLoginOrProfile();

	function renderLoginOrProfile() {
		const navbarSupportedContent = document.querySelector('#navbarSupportedContent');
		if (getCookie('auth-token')) {
			const a = document.createElement('a');
			a.href = '#';
			a.classList.add('navbar-brand');
			a.innerHTML =
				'<img src="https://images.jodu555.de/Avatar-M.png" alt="" width="48" height="48"/>';
			addCanvasToggle(a, '#offcanvasProfile');
			navbarSupportedContent.appendChild(a);
		} else {
			const a = document.createElement('a');
			a.classList.add('btn', 'btn-outline-info');
			a.innerText = 'Login / Register';
			addCanvasToggle(a, '#offcanvasLogin');
			navbarSupportedContent.appendChild(a);
		}
	}

	function addCanvasToggle(element, id) {
		element.setAttribute('data-bs-toggle', 'offcanvas');
		element.setAttribute('data-bs-target', id);
		element.setAttribute('aria-controls', id);
	}

	function getCurrentPage() {
		const path = window.location.pathname;
		let out;
		navigation.forEach((nav) => {
			if (
				(Array.isArray(nav.page) && nav.page.includes(path)) ||
				nav.page == path ||
				'/' + nav.page == path
			)
				out = nav;
		});
		return out;
	}

	function generateNavBar(selector, navigation) {
		const element = document.querySelector(selector);
		navigation.forEach((nav) => {
			const li = document.createElement('li');
			li.classList.add('nav-item');
			const a = document.createElement('a');
			a.classList.add('nav-link');
			if (currentPage && currentPage.display == nav.display) a.classList.add('active');
			a.href = Array.isArray(nav.page) ? nav.page[nav.page.length - 1] : nav.page;
			a.innerText = nav.display;
			li.appendChild(a);
			element.appendChild(li);
		});
	}
</script>
